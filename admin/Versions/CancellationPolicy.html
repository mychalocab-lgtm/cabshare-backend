<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CabShare Admin Panel - Simplified Cancellation Policies</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Load Supabase from CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <style>
    :root {
      --primary: #0ea5e9;
      --primary-dark: #0284c7;
      --secondary: #64748b;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --background: #f8fafc;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --text-muted: #64748b;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --border-radius: 8px;
      --font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font-family); background: var(--background); color: var(--text); line-height: 1.5; }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 1rem; }
    
    /* Header */
    .header { background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
    .header-content { display: flex; align-items: center; justify-content: space-between; padding: 1rem 0; }
    .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
    .user-menu { display: flex; align-items: center; gap: 1rem; }
    
    /* Login Form */
    .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: var(--background); }
    .login-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--border-radius); box-shadow: var(--shadow-lg); padding: 2rem; width: 100%; max-width: 400px; }
    .login-title { font-size: 1.5rem; font-weight: 600; text-align: center; margin-bottom: 2rem; color: var(--primary); }
    
    /* Form Elements */
    .form-group { margin-bottom: 1rem; }
    .label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--text); margin-bottom: 0.5rem; }
    .input { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--border-radius); font-size: 0.875rem; transition: border-color 0.2s, box-shadow 0.2s; }
    .input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }
    
    /* Buttons */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1rem; border: none; border-radius: var(--border-radius); font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; }
    .btn-primary { background: var(--primary); color: white; width: 100%; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-outline { background: transparent; color: var(--primary); border: 1px solid var(--primary); }
    .btn-outline:hover { background: var(--primary); color: white; }
    .btn-sm { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
    
    /* Loading */
    .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none; }
    
    /* Messages */
    .error-message { background: rgba(239, 68, 68, 0.1); color: var(--danger); padding: 0.75rem; border-radius: var(--border-radius); border: 1px solid rgba(239, 68, 68, 0.2); margin-bottom: 1rem; font-size: 0.875rem; }
    .success-message { background: rgba(34, 197, 94, 0.1); color: var(--success); padding: 0.75rem; border-radius: var(--border-radius); border: 1px solid rgba(34, 197, 94, 0.2); margin-bottom: 1rem; font-size: 0.875rem; }
    
    /* Layout */
    .main-content { display: none; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    
    /* Navigation */
    .nav-tabs { background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 73px; z-index: 90; }
    .nav-tabs-list { display: flex; overflow-x: auto; padding: 0 1rem; }
    .nav-tab { background: none; border: none; padding: 1rem 1.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 500; color: var(--text-muted); border-bottom: 2px solid transparent; white-space: nowrap; transition: all 0.2s; }
    .nav-tab:hover { color: var(--text); background: rgba(14, 165, 233, 0.05); }
    .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    
    /* Cards */
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
    .card-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-size: 1.125rem; font-weight: 600; color: var(--text); }
    .card-content { padding: 1.5rem; }
    
    /* Dashboard */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--border-radius); padding: 1.5rem; text-align: center; }
    .stat-number { font-size: 2rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; }
    .stat-label { color: var(--text-muted); font-size: 0.875rem; }
    
    /* Tables */
    .table-container { overflow-x: auto; }
    .table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .table th, .table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
    .table th { background: var(--background); font-weight: 600; }
    .table tr:hover { background: rgba(14, 165, 233, 0.02); }
    
    /* Badges */
    .badge { display: inline-block; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 500; border-radius: 4px; }
    .badge-success { background: rgba(34, 197, 94, 0.1); color: var(--success); }
    .badge-secondary { background: rgba(100, 116, 139, 0.1); color: var(--secondary); }
    
    /* Policy Info */
    .policy-info { background: rgba(14, 165, 233, 0.05); border: 1px solid rgba(14, 165, 233, 0.2); border-radius: var(--border-radius); padding: 1rem; margin-bottom: 1rem; font-size: 0.875rem; color: var(--primary); }
    
    /* Modals */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: var(--surface); border-radius: var(--border-radius); padding: 2rem; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .modal-title { font-size: 1.25rem; font-weight: 600; }
    .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
    .close-btn:hover { color: var(--text); }
    
    /* Form layouts */
    .form-row { display: flex; gap: 1rem; margin-bottom: 1rem; }
    .form-row .form-group { flex: 1; margin-bottom: 0; }
    .text-center { text-align: center; }
    .text-muted { color: var(--text-muted); }
    
    /* Status indicators */
    .status-indicator { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    .status-dot.success { background: var(--success); }
    .status-dot.warning { background: var(--warning); }
  </style>
</head>
<body>
  <!-- Login Form -->
  <div id="loginContainer" class="login-container">
    <div class="login-card">
      <h1 class="login-title">ðŸš— CabShare Admin Panel</h1>
      <div id="errorMessage" class="error-message hidden"></div>
      <div id="successMessage" class="success-message hidden"></div>
      <form id="loginForm">
        <div class="form-group">
          <label class="label">Supabase URL</label>
          <input type="url" class="input" id="supabaseUrl" placeholder="https://xxx.supabase.co" required>
        </div>
        <div class="form-group">
          <label class="label">Supabase Anon Key</label>
          <input type="password" class="input" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." required>
        </div>
        <div class="form-group">
          <label class="label">Email</label>
          <input type="email" class="input" id="loginEmail" placeholder="admin@cabshare.com" required>
        </div>
        <div class="form-group">
          <label class="label">Password</label>
          <input type="password" class="input" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
        </div>
        <button type="submit" class="btn btn-primary" id="loginBtn">
          <span id="loginSpinner" class="spinner hidden"></span>
          <span id="loginText">Sign In</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="main-content">
    <header class="header">
      <div class="container">
        <div class="header-content">
          <div class="logo">ðŸš— CabShare Admin Panel</div>
          <div class="user-menu">
            <span id="userEmail" class="text-muted"></span>
            <button class="btn btn-outline btn-sm" id="logoutBtn">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <nav class="nav-tabs">
      <div class="container">
        <div class="nav-tabs-list">
          <button class="nav-tab active" data-tab="dashboard">ðŸ“Š Dashboard</button>
          <button class="nav-tab" data-tab="policies">ðŸ“‹ Cancellation Policies</button>
          <button class="nav-tab" data-tab="users">ðŸ‘¥ Users</button>
          <button class="nav-tab" data-tab="rides">ðŸš— Rides</button>
        </div>
      </div>
    </nav>

    <main class="container" style="padding: 2rem 1rem;">
      <!-- Dashboard Tab -->
      <div id="dashboard" class="tab-panel active">
        <div class="dashboard-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalRides">-</div>
            <div class="stat-label">Total Rides</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalBookings">-</div>
            <div class="stat-label">Total Bookings</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalUsers">-</div>
            <div class="stat-label">Total Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalPolicies">3</div>
            <div class="stat-label">Active Policies</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Admin Panel Status</h2>
          </div>
          <div class="card-content">
            <div class="status-indicator">
              <div class="status-dot success"></div>
              <strong>Cancellation policies simplified!</strong> Now using unified policies per ride type.
            </div>
            <p style="margin-top: 1rem;">âœ… Each ride type has ONE policy applying to both riders and drivers<br>
            âœ… Simplified penalty calculations<br>
            âœ… Cleaner admin interface<br>
            âœ… Compatible with existing database structure</p>
          </div>
        </div>
      </div>

      <!-- Policies Tab -->
      <div id="policies" class="tab-panel">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Cancellation Policies Management</h2>
          </div>
          <div class="card-content">
            <div class="policy-info">
              <strong>ðŸ“‹ Simplified Policy Structure:</strong> Each ride type now has ONE unified policy that applies to both riders and drivers. This eliminates confusion and simplifies deposit calculations in the backend. Penalties are based on cancellation timing relative to departure.
            </div>
            
            <div class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    <th>Ride Type</th>
                    <th>12+ Hours Before</th>
                    <th>6-12 Hours Before</th>
                    <th>0-6 Hours Before</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="policiesTable">
                  <tr><td colspan="6" class="text-center text-muted">Loading policies...</td></tr>
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 1rem; padding: 1rem; background: rgba(100, 116, 139, 0.05); border-radius: var(--border-radius); font-size: 0.875rem; color: var(--text-muted);">
              <strong>Policy Logic:</strong> When a booking is cancelled, the system calculates hours remaining until departure and applies the appropriate penalty percentage to the deposit amount. The penalty is transferred from the cancelling party to the other party.
            </div>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="users" class="tab-panel">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Users Management</h2>
          </div>
          <div class="card-content">
            <div class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Role</th>
                    <th>Joined</th>
                  </tr>
                </thead>
                <tbody id="usersTable">
                  <tr><td colspan="5" class="text-center text-muted">Loading users...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Rides Tab -->
      <div id="rides" class="tab-panel">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Rides Management</h2>
          </div>
          <div class="card-content">
            <div class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    <th>Route</th>
                    <th>Date & Time</th>
                    <th>Available Seats</th>
                    <th>Price per Seat</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="ridesTable">
                  <tr><td colspan="5" class="text-center text-muted">Loading rides...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Edit Policy Modal -->
  <div id="editPolicyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Cancellation Policy</h3>
        <button class="close-btn" onclick="closeModal('editPolicyModal')">&times;</button>
      </div>
      <form id="editPolicyForm">
        <div class="form-group">
          <label class="label">Ride Type</label>
          <input type="text" class="input" id="editPolicyRideType" readonly>
        </div>
        <div class="form-group">
          <label class="label">Applies To</label>
          <input type="text" class="input" value="Both Riders and Drivers" readonly>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="label">12+ Hours Before (%)</label>
            <input type="number" class="input" id="editPolicy12Plus" min="0" max="100" required>
            <small class="text-muted">Penalty for cancellations 12+ hours before departure</small>
          </div>
          <div class="form-group">
            <label class="label">6-12 Hours Before (%)</label>
            <input type="number" class="input" id="editPolicy6To12" min="0" max="100" required>
            <small class="text-muted">Penalty for cancellations 6-12 hours before departure</small>
          </div>
          <div class="form-group">
            <label class="label">0-6 Hours Before (%)</label>
            <input type="number" class="input" id="editPolicy0To6" min="0" max="100" required>
            <small class="text-muted">Penalty for cancellations 0-6 hours before departure</small>
          </div>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
          <button type="button" class="btn btn-outline" onclick="closeModal('editPolicyModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Policy</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Global Variables
    let supabaseClient = null;
    let currentUser = null;

    // Configuration Management
    const config = {
      get supabaseUrl() { return localStorage.getItem('supabase_url') || ''; },
      set supabaseUrl(value) { localStorage.setItem('supabase_url', value); },
      get supabaseKey() { return localStorage.getItem('supabase_key') || ''; },
      set supabaseKey(value) { localStorage.setItem('supabase_key', value); }
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      console.log('CabShare Admin Panel loaded');
      document.getElementById('supabaseUrl').value = config.supabaseUrl;
      document.getElementById('supabaseKey').value = config.supabaseKey;
      setupEventListeners();
      if (config.supabaseUrl && config.supabaseKey) {
        initializeSupabase();
      }
    });

    // Event Listeners Setup
    function setupEventListeners() {
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });
      document.getElementById('editPolicyForm').addEventListener('submit', handleEditPolicy);
    }

    // Supabase Initialization
    function initializeSupabase() {
      try {
        if (!config.supabaseUrl || !config.supabaseKey) return false;
        supabaseClient = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
        console.log('Supabase initialized successfully');
        return true;
      } catch (error) {
        console.error('Failed to initialize Supabase:', error);
        showError('Failed to initialize Supabase: ' + error.message);
        return false;
      }
    }

    // Login Handler
    async function handleLogin(event) {
      event.preventDefault();
      const loginBtn = document.getElementById('loginBtn');
      const loginSpinner = document.getElementById('loginSpinner');
      const loginText = document.getElementById('loginText');
      
      loginBtn.disabled = true;
      loginSpinner.classList.remove('hidden');
      loginText.textContent = 'Signing in...';
      hideMessages();

      try {
        const supabaseUrl = document.getElementById('supabaseUrl').value.trim();
        const supabaseKey = document.getElementById('supabaseKey').value.trim();
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;

        if (!supabaseUrl || !supabaseKey || !email || !password) {
          throw new Error('Please fill in all fields');
        }

        config.supabaseUrl = supabaseUrl;
        config.supabaseKey = supabaseKey;

        if (!initializeSupabase()) throw new Error('Failed to initialize Supabase');

        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;

        // Check admin status
        const { data: adminData, error: adminError } = await supabaseClient
          .from('admins')
          .select('user_id')
          .eq('user_id', data.user.id)
          .single();

        if (adminError && adminError.code !== 'PGRST116') {
          throw new Error('Error checking admin status: ' + adminError.message);
        }

        if (!adminData) {
          throw new Error('Access denied: You are not an admin user. Please contact the administrator to add your account to the admins table.');
        }

        currentUser = data.user;
        showSuccess('Login successful! Redirecting...');
        
        setTimeout(() => {
          showMainInterface();
          loadDashboard();
        }, 1000);

      } catch (error) {
        console.error('Login error:', error);
        showError(error.message || 'Login failed');
      } finally {
        loginBtn.disabled = false;
        loginSpinner.classList.add('hidden');
        loginText.textContent = 'Sign In';
      }
    }

    // Logout Handler
    function handleLogout() {
      if (supabaseClient) supabaseClient.auth.signOut();
      currentUser = null;
      showLoginForm();
      showSuccess('Logged out successfully');
    }

    // UI State Management
    function showLoginForm() {
      document.getElementById('loginContainer').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'none';
    }

    function showMainInterface() {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      if (currentUser?.email) {
        document.getElementById('userEmail').textContent = currentUser.email;
      }
    }

    // Tab Management
    function switchTab(tabId) {
      console.log('Switching to tab:', tabId);
      
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');

      switch(tabId) {
        case 'dashboard': loadDashboard(); break;
        case 'policies': loadPolicies(); break;
        case 'users': loadUsers(); break;
        case 'rides': loadRides(); break;
      }
    }

    // Dashboard Data Loading
    async function loadDashboard() {
      try {
        const [ridesResult, bookingsResult, usersResult] = await Promise.all([
          supabaseClient.from('rides').select('*', { count: 'exact', head: true }),
          supabaseClient.from('bookings').select('*', { count: 'exact', head: true }),
          supabaseClient.from('profiles').select('*', { count: 'exact', head: true })
        ]);
        
        document.getElementById('totalRides').textContent = ridesResult.count || 0;
        document.getElementById('totalBookings').textContent = bookingsResult.count || 0;
        document.getElementById('totalUsers').textContent = usersResult.count || 0;
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // Policies Management - UPDATED FOR EXISTING SCHEMA
    async function loadPolicies() {
      try {
        await initializeDefaultPolicies();
        
        const { data, error } = await supabaseClient
          .from('cancellation_policies')
          .select('*')
          .eq('actor', 'both')
          .eq('is_active', true)
          .order('ride_type');

        if (error) throw error;

        const policiesTable = document.getElementById('policiesTable');
        policiesTable.innerHTML = '';

        if (data?.length > 0) {
          data.forEach(policy => {
            const row = document.createElement('tr');
            // Handle both integer and decimal penalty values from existing schema
            const penalty1 = Math.round(parseFloat(policy.penalty_percentage_1) || 0);
            const penalty2 = Math.round(parseFloat(policy.penalty_percentage_2) || 0);
            const penalty3 = Math.round(parseFloat(policy.penalty_percentage_3) || 0);
            
            row.innerHTML = `
              <td><span class="badge badge-secondary">${policy.ride_type.replace('_', ' ')}</span></td>
              <td>${penalty1}%</td>
              <td>${penalty2}%</td>
              <td>${penalty3}%</td>
              <td><span class="badge badge-success">Active</span></td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editPolicy('${policy.ride_type}', ${penalty1}, ${penalty2}, ${penalty3})">Edit</button>
              </td>
            `;
            policiesTable.appendChild(row);
          });
        } else {
          policiesTable.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No policies found. Default policies will be created automatically.</td></tr>';
        }
      } catch (error) {
        console.error('Error loading policies:', error);
        document.getElementById('policiesTable').innerHTML = '<tr><td colspan="6" class="text-center text-muted">Error loading policies. Please check your database connection.</td></tr>';
      }
    }

    // Initialize Default Policies - COMPATIBLE WITH EXISTING SCHEMA
    async function initializeDefaultPolicies() {
      const defaultPolicies = [
        { ride_type: 'private', penalty_percentage_1: 20, penalty_percentage_2: 40, penalty_percentage_3: 60 },
        { ride_type: 'commercial', penalty_percentage_1: 20, penalty_percentage_2: 40, penalty_percentage_3: 60 },
        { ride_type: 'commercial_full', penalty_percentage_1: 20, penalty_percentage_2: 40, penalty_percentage_3: 60 }
      ];

      for (const policy of defaultPolicies) {
        try {
          const { data } = await supabaseClient
            .from('cancellation_policies')
            .select('*')
            .eq('ride_type', policy.ride_type)
            .eq('actor', 'both')
            .single();

          if (!data) {
            // Policy doesn't exist, create it
            await supabaseClient
              .from('cancellation_policies')
              .insert({
                ride_type: policy.ride_type,
                actor: 'both',
                hours_threshold_1: 12,
                penalty_percentage_1: policy.penalty_percentage_1, // Will be stored as numeric
                hours_threshold_2: 6,
                penalty_percentage_2: policy.penalty_percentage_2, // Will be stored as numeric
                hours_threshold_3: 0,
                penalty_percentage_3: policy.penalty_percentage_3, // Will be stored as numeric
                is_active: true
              });
          }
        } catch (error) {
          console.error('Error initializing policy for', policy.ride_type, ':', error);
        }
      }
    }

    // Policy Edit Handler - UPDATED FOR EXISTING SCHEMA
    async function handleEditPolicy(event) {
      event.preventDefault();
      try {
        const rideType = document.getElementById('editPolicyRideType').value;
        const penalty1 = parseInt(document.getElementById('editPolicy12Plus').value);
        const penalty2 = parseInt(document.getElementById('editPolicy6To12').value);
        const penalty3 = parseInt(document.getElementById('editPolicy0To6').value);

        // Validate penalty values
        if (penalty1 < 0 || penalty1 > 100 || penalty2 < 0 || penalty2 > 100 || penalty3 < 0 || penalty3 > 100) {
          throw new Error('Penalty percentages must be between 0 and 100');
        }

        // Update with proper numeric values (compatible with existing schema)
        const { error } = await supabaseClient
          .from('cancellation_policies')
          .update({
            penalty_percentage_1: penalty1, // Will be converted to numeric in DB
            penalty_percentage_2: penalty2, // Will be converted to numeric in DB
            penalty_percentage_3: penalty3, // Will be converted to numeric in DB
            updated_at: new Date().toISOString()
          })
          .eq('ride_type', rideType)
          .eq('actor', 'both');

        if (error) throw error;

        showSuccess('Policy updated successfully');
        closeModal('editPolicyModal');
        loadPolicies();
      } catch (error) {
        console.error('Error updating policy:', error);
        showError('Failed to update policy: ' + error.message);
      }
    }

    // Users Data Loading
    async function loadUsers() {
      try {
        const { data, error } = await supabaseClient
          .from('profiles')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;

        const usersTable = document.getElementById('usersTable');
        usersTable.innerHTML = '';

        if (data?.length > 0) {
          data.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${user.full_name || user.name || '-'}</td>
              <td>${user.email || '-'}</td>
              <td>${user.phone || '-'}</td>
              <td><span class="badge badge-secondary">${user.role || 'rider'}</span></td>
              <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : '-'}</td>
            `;
            usersTable.appendChild(row);
          });
        } else {
          usersTable.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No users found</td></tr>';
        }
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTable').innerHTML = '<tr><td colspan="5" class="text-center text-muted">Error loading users</td></tr>';
      }
    }

    // Rides Data Loading
    async function loadRides() {
      try {
        const { data, error } = await supabaseClient
          .from('rides')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;

        const ridesTable = document.getElementById('ridesTable');
        ridesTable.innerHTML = '';

        if (data?.length > 0) {
          data.forEach(ride => {
            const row = document.createElement('tr');
            const fromTo = `${ride.from || 'Unknown'} â†’ ${ride.to || 'Unknown'}`;
            const dateTime = ride.depart_date ? 
              `${new Date(ride.depart_date).toLocaleDateString()} ${ride.depart_time || ''}` : 
              (ride.start_time ? new Date(ride.start_time).toLocaleString() : '-');
            
            row.innerHTML = `
              <td>${fromTo}</td>
              <td>${dateTime}</td>
              <td>${ride.seats_available || ride.seats || '-'}</td>
              <td>â‚¹${ride.price_per_seat_inr || ride.price_inr || 0}</td>
              <td><span class="badge badge-success">${ride.status || 'published'}</span></td>
            `;
            ridesTable.appendChild(row);
          });
        } else {
          ridesTable.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No rides found</td></tr>';
        }
      } catch (error) {
        console.error('Error loading rides:', error);
        document.getElementById('ridesTable').innerHTML = '<tr><td colspan="5" class="text-center text-muted">Error loading rides</td></tr>';
      }
    }

    // Message Display Functions
    function showError(message) {
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
      successMessage.classList.add('hidden');
      console.error('Error:', message);
    }

    function showSuccess(message) {
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');
      successMessage.textContent = message;
      successMessage.classList.remove('hidden');
      errorMessage.classList.add('hidden');
      console.log('Success:', message);
    }

    function hideMessages() {
      document.getElementById('errorMessage').classList.add('hidden');
      document.getElementById('successMessage').classList.add('hidden');
    }

    // Modal Management
    function showModal(modalId) {
      document.getElementById(modalId).classList.add('show');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // Global Functions for onclick handlers
    window.editPolicy = function(rideType, penalty12Plus, penalty6To12, penalty0To6) {
      document.getElementById('editPolicyRideType').value = rideType;
      document.getElementById('editPolicy12Plus').value = penalty12Plus;
      document.getElementById('editPolicy6To12').value = penalty6To12;
      document.getElementById('editPolicy0To6').value = penalty0To6;
      showModal('editPolicyModal');
    };

    window.closeModal = closeModal;

    // Auto-login check on page load
    window.addEventListener('load', async () => {
      if (supabaseClient) {
        try {
          const { data: { session } } = await supabaseClient.auth.getSession();
          if (session && session.user) {
            // Check if user is admin
            const { data: adminData } = await supabaseClient
              .from('admins')
              .select('user_id')
              .eq('user_id', session.user.id)
              .single();
            
            if (adminData) {
              currentUser = session.user;
              showMainInterface();
              loadDashboard();
            }
          }
        } catch (error) {
          console.error('Session check error:', error);
        }
      }
    });

    // Console welcome message
    console.log(`
ðŸš— CabShare Admin Panel
=====================
âœ… Simplified cancellation policies 
âœ… Compatible with existing database schema
âœ… One policy per ride type (applies to both riders & drivers)
âœ… Real-time policy management
    `);
  </script>
</body>
</html>