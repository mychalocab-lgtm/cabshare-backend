<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CabShare Admin Panel</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --success: #10b981;
            --danger: #ef4444;
            --background: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-muted: #64748b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui; background: var(--background); color: var(--text); }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); }
        .login-card { background: var(--surface); padding: 2rem; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .login-card h1 { text-align: center; margin-bottom: 2rem; font-size: 1.5rem; }
        .main-content { display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 1rem 2rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .nav-tabs { display: flex; background: var(--surface); border-radius: 8px; padding: 0.5rem; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .nav-tab { flex: 1; text-align: center; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 500; color: var(--text-muted); }
        .nav-tab:hover { background: var(--border); }
        .nav-tab.active { background: var(--primary); color: white; }
        .card { background: var(--surface); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card h2, .card h3 { margin-bottom: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-actions { display: flex; gap: 1rem; margin-top: 1rem; }
        .label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .input, .select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; }
        .input:focus, .select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }
        .btn { padding: 0.75rem 1rem; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; color: var(--text); border: 1px solid var(--border); }
        .btn-outline:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 0.5rem 0.75rem; font-size: 0.8rem; }
        .table-container { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
        .table th { background: var(--background); font-weight: 600; }
        .table tr:hover { background: var(--background); }
        .table tr.clickable { cursor: pointer; }
        .table tr.clickable:hover { background: #e0f2fe; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--surface); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--primary); }
        .stat-label { color: var(--text-muted); margin-top: 0.5rem; }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mb-0 { margin-bottom: 0; }
        .route-info { background: #e0f2fe; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
        .stop-order { background: var(--primary); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; }
        .loading { text-align: center; padding: 2rem; color: var(--text-muted); }
        .error { background: #fef2f2; color: var(--danger); padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
        .success { background: #f0fdf4; color: var(--success); padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
        @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } .nav-tabs { flex-direction: column; } }
    </style>
</head>
<body>
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <h1>üöó CabShare Admin</h1>
            <div id="loginError" class="error hidden"></div>
            <form id="loginForm">
                <div class="form-group"><label class="label">Supabase URL</label><input type="url" class="input" id="supabaseUrl" required></div>
                <div class="form-group"><label class="label">Supabase Key</label><input type="password" class="input" id="supabaseKey" required></div>
                <div class="form-group"><label class="label">Email</label><input type="email" class="input" id="loginEmail" required></div>
                <div class="form-group"><label class="label">Password</label><input type="password" class="input" id="loginPassword" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
            </form>
        </div>
    </div>

    <div id="mainContent" class="main-content">
        <div class="container">
            <div class="header">
                <h1>üöó CabShare Admin Panel</h1>
                <button id="logoutBtn" class="btn btn-outline">Logout</button>
            </div>

            <nav class="nav-tabs">
                <div class="nav-tab active" data-tab="dashboard">üìä Dashboard</div>
                <div class="nav-tab" data-tab="cities-routes">üõ£Ô∏è Cities & Routes</div>
                <div class="nav-tab" data-tab="users">üë• Users</div>
                <div class="nav-tab" data-tab="rides">üöó Rides</div>
                <div class="nav-tab" data-tab="financial">üí∞ Financial</div>
            </nav>

            <!-- Dashboard -->
            <div id="dashboard" class="tab-panel active">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="totalUsers">-</div><div class="stat-label">Total Users</div></div>
                    <div class="stat-card"><div class="stat-value" id="totalRides">-</div><div class="stat-label">Total Rides</div></div>
                    <div class="stat-card"><div class="stat-value" id="totalCities">-</div><div class="stat-label">Cities</div></div>
                    <div class="stat-card"><div class="stat-value" id="totalRoutes">-</div><div class="stat-label">Routes</div></div>
                </div>
                <div class="card"><h3>Recent Activity</h3><div id="recentActivity" class="loading">Loading...</div></div>
            </div>

            <!-- Cities & Routes -->
            <div id="cities-routes" class="tab-panel">
                <div class="card">
                    <h3>üèôÔ∏è Cities Management</h3>
                    <div class="form-actions">
                        <input type="text" id="newCityName" class="input" placeholder="City Name" style="flex: 1; margin-bottom: 0;">
                        <input type="text" id="newCityState" class="input" placeholder="State" style="flex: 1; margin-bottom: 0;">
                        <button onclick="addCity()" class="btn btn-primary">Add City</button>
                    </div>
                    <div class="table-container" style="margin-top: 1rem;">
                        <table class="table">
                            <thead><tr><th>City</th><th>State</th><th>Actions</th></tr></thead>
                            <tbody id="citiesTable"><tr><td colspan="3" class="loading">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3>üõ£Ô∏è Routes Between Cities</h3>
                    <div class="form-row">
                        <div class="form-group mb-0"><label class="label">From City</label><select id="fromCitySelect" class="select"><option value="">Select From City</option></select></div>
                        <div class="form-group mb-0"><label class="label">To City</label><select id="toCitySelect" class="select"><option value="">Select To City</option></select></div>
                    </div>
                    <div class="form-actions">
                        <button onclick="loadRoutes()" class="btn btn-primary">Load Routes</button>
                        <button onclick="showAddRouteForm()" class="btn btn-outline" id="addRouteBtn" style="display: none;">Add New Route</button>
                    </div>

                    <div id="addRouteForm" class="hidden" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                        <h4>Add New Route</h4>
                        <div class="form-row">
                            <div class="form-group"><label class="label">Route Name</label><input type="text" id="newRouteName" class="input" placeholder="Route Name"></div>
                            <div class="form-group"><label class="label">Distance (km)</label><input type="number" id="newRouteDistance" class="input" step="0.1"></div>
                        </div>
                        <div class="form-actions">
                            <button onclick="hideAddRouteForm()" class="btn btn-outline">Cancel</button>
                            <button onclick="addRoute()" class="btn btn-primary">Add Route</button>
                        </div>
                    </div>

                    <div class="table-container" style="margin-top: 1rem;">
                        <table class="table">
                            <thead><tr><th>Route Name</th><th>Distance</th><th>Stops</th><th>Actions</th></tr></thead>
                            <tbody id="routesTable"><tr><td colspan="4" class="text-center">Select cities to view routes</td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div id="stopsSection" class="card hidden">
                    <div class="route-info">
                        <h3>üìç Stops for Route: <span id="selectedRouteName">-</span></h3>
                        <p><strong>Route:</strong> <span id="selectedRouteDetails">-</span></p>
                    </div>
                    <div class="form-actions">
                        <input type="text" id="newStopName" class="input" placeholder="Stop Name" style="flex: 1; margin-bottom: 0;">
                        <input type="number" id="newStopOrder" class="input" placeholder="Order" style="width: 100px; margin-bottom: 0;">
                        <button onclick="addStop()" class="btn btn-primary">Add Stop</button>
                        <button onclick="hideStopsSection()" class="btn btn-outline">Close</button>
                    </div>
                    <div class="table-container" style="margin-top: 1rem;">
                        <table class="table">
                            <thead><tr><th>Order</th><th>Stop Name</th><th>Actions</th></tr></thead>
                            <tbody id="stopsTable"><tr><td colspan="3" class="loading">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users -->
            <div id="users" class="tab-panel">
                <div class="card">
                    <h3>üë• Users Management</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead><tr><th>Email</th><th>Role</th><th>Verified</th><th>Joined</th></tr></thead>
                            <tbody id="usersTable"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Rides -->
            <div id="rides" class="tab-panel">
                <div class="card">
                    <h3>üöó Rides Management</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead><tr><th>Route</th><th>Driver</th><th>Date</th><th>Status</th></tr></thead>
                            <tbody id="ridesTable"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Financial -->
            <div id="financial" class="tab-panel">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="walletBalance">‚Çπ0</div><div class="stat-label">Total Wallet Balance</div></div>
                </div>
                <div class="card">
                    <h3>üí∞ Recent Transactions</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead><tr><th>Date</th><th>User</th><th>Amount</th><th>Type</th></tr></thead>
                            <tbody id="transactionsTable"><tr><td colspan="4" class="text-center">No transactions found</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let supabaseClient = null;
        let currentUser = null;
        let cities = [];
        let currentRoutes = [];
        let selectedRoute = null;

        const config = {
            get supabaseUrl() { return localStorage.getItem('supabase_url') || ''; },
            set supabaseUrl(value) { localStorage.setItem('supabase_url', value); },
            get supabaseKey() { return localStorage.getItem('supabase_key') || ''; },
            set supabaseKey(value) { localStorage.setItem('supabase_key', value); }
        };

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('supabaseUrl').value = config.supabaseUrl;
            document.getElementById('supabaseKey').value = config.supabaseKey;
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            checkSession();
        });

        async function checkSession() {
            if (config.supabaseUrl && config.supabaseKey) {
                try {
                    supabaseClient = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session && session.user) {
                        const { data: adminData } = await supabaseClient.from('admins').select('user_id').eq('user_id', session.user.id).single();
                        if (adminData) {
                            currentUser = session.user;
                            showMainInterface();
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Session check error:', error);
                }
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!url || !key || !email || !password) {
                showError('Please fill in all fields');
                return;
            }

            try {
                config.supabaseUrl = url;
                config.supabaseKey = key;
                supabaseClient = window.supabase.createClient(url, key);
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email: email, password: password });
                if (error) throw error;

                const { data: adminData, error: adminError } = await supabaseClient.from('admins').select('user_id').eq('user_id', data.user.id).single();
                if (adminError && adminError.code !== 'PGRST116') throw adminError;
                if (!adminData) throw new Error('Access denied: You are not authorized as an admin.');

                currentUser = data.user;
                showMainInterface();
                hideError();
            } catch (error) {
                console.error('Login error:', error);
                showError(error.message);
            }
        }

        function handleLogout() {
            if (supabaseClient) supabaseClient.auth.signOut();
            currentUser = null;
            selectedRoute = null;
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            hideError();
        }

        function showMainInterface() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadDashboard();
            loadCities();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            switch(tabId) {
                case 'dashboard': loadDashboard(); break;
                case 'cities-routes': loadCities(); break;
                case 'users': loadUsers(); break;
                case 'rides': loadRides(); break;
                case 'financial': loadFinancial(); break;
            }
        }

        async function loadDashboard() {
            try {
                const [usersResult, ridesResult, citiesResult, routesResult] = await Promise.all([
                    supabaseClient.from('profiles').select('id', { count: 'exact', head: true }),
                    supabaseClient.from('rides').select('id', { count: 'exact', head: true }),
                    supabaseClient.from('cities').select('id', { count: 'exact', head: true }),
                    supabaseClient.from('routes').select('id', { count: 'exact', head: true })
                ]);

                document.getElementById('totalUsers').textContent = usersResult.count || 0;
                document.getElementById('totalRides').textContent = ridesResult.count || 0;
                document.getElementById('totalCities').textContent = citiesResult.count || 0;
                document.getElementById('totalRoutes').textContent = routesResult.count || 0;
                document.getElementById('recentActivity').innerHTML = '<p>Dashboard loaded successfully!</p>';
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadCities() {
            try {
                const { data, error } = await supabaseClient.from('cities').select('*').order('name');
                if (error) throw error;
                cities = data || [];
                updateCitiesTable();
                updateCitySelects();
            } catch (error) {
                console.error('Error loading cities:', error);
                document.getElementById('citiesTable').innerHTML = '<tr><td colspan="3" style="color: var(--danger);">Error loading cities</td></tr>';
            }
        }

        function updateCitiesTable() {
            const tbody = document.getElementById('citiesTable');
            if (cities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center">No cities found</td></tr>';
                return;
            }
            tbody.innerHTML = cities.map(city => `
                <tr>
                    <td><strong>${city.name}</strong></td>
                    <td>${city.state || '-'}</td>
                    <td><button onclick="deleteCity('${city.id}')" class="btn btn-danger btn-sm">Delete</button></td>
                </tr>
            `).join('');
        }

        function updateCitySelects() {
            const fromSelect = document.getElementById('fromCitySelect');
            const toSelect = document.getElementById('toCitySelect');
            const options = cities.map(city => `<option value="${city.id}">${city.name}, ${city.state || 'N/A'}</option>`).join('');
            fromSelect.innerHTML = '<option value="">Select From City</option>' + options;
            toSelect.innerHTML = '<option value="">Select To City</option>' + options;
        }

        async function addCity() {
            const name = document.getElementById('newCityName').value.trim();
            const state = document.getElementById('newCityState').value.trim();
            if (!name) { alert('Please enter a city name'); return; }
            try {
                const { error } = await supabaseClient.from('cities').insert({ name: name, state: state || null });
                if (error) throw error;
                document.getElementById('newCityName').value = '';
                document.getElementById('newCityState').value = '';
                await loadCities();
                showSuccess('City added successfully!');
            } catch (error) {
                alert('Error adding city: ' + error.message);
            }
        }

        async function deleteCity(cityId) {
            if (!confirm('Delete this city and all its routes?')) return;
            try {
                const { error } = await supabaseClient.from('cities').delete().eq('id', cityId);
                if (error) throw error;
                await loadCities();
                showSuccess('City deleted successfully!');
            } catch (error) {
                alert('Error deleting city: ' + error.message);
            }
        }

        async function loadRoutes() {
            const fromCityId = document.getElementById('fromCitySelect').value;
            const toCityId = document.getElementById('toCitySelect').value;
            if (!fromCityId || !toCityId) { alert('Please select both cities'); return; }
            if (fromCityId === toCityId) { alert('Cities cannot be the same'); return; }

            try {
                const { data, error } = await supabaseClient
                    .from('routes')
                    .select('*, from_city:cities!routes_from_city_id_fkey(name), to_city:cities!routes_to_city_id_fkey(name)')
                    .eq('from_city_id', fromCityId)
                    .eq('to_city_id', toCityId)
                    .order('name');
                if (error) throw error;

                currentRoutes = data || [];
                updateRoutesTable();
                document.getElementById('addRouteBtn').style.display = 'inline-flex';
            } catch (error) {
                console.error('Error loading routes:', error);
                document.getElementById('routesTable').innerHTML = '<tr><td colspan="4" style="color: var(--danger);">Error loading routes</td></tr>';
            }
        }

        function updateRoutesTable() {
            const tbody = document.getElementById('routesTable');
            if (currentRoutes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No routes found between selected cities</td></tr>';
                return;
            }
            tbody.innerHTML = currentRoutes.map(route => `
                <tr class="clickable" onclick="selectRoute('${route.id}', '${route.name}', '${route.from_city?.name}', '${route.to_city?.name}')">
                    <td><strong>${route.name}</strong></td>
                    <td>${route.distance ? route.distance + ' km' : '-'}</td>
                    <td>-</td>
                    <td><button onclick="event.stopPropagation(); deleteRoute('${route.id}')" class="btn btn-danger btn-sm">Delete</button></td>
                </tr>
            `).join('');
        }

        function showAddRouteForm() {
            document.getElementById('addRouteForm').classList.remove('hidden');
            document.getElementById('addRouteBtn').textContent = 'Hide Form';
            document.getElementById('addRouteBtn').onclick = hideAddRouteForm;
        }

        function hideAddRouteForm() {
            document.getElementById('addRouteForm').classList.add('hidden');
            document.getElementById('addRouteBtn').textContent = 'Add New Route';
            document.getElementById('addRouteBtn').onclick = showAddRouteForm;
            document.getElementById('newRouteName').value = '';
            document.getElementById('newRouteDistance').value = '';
        }

        async function addRoute() {
            const name = document.getElementById('newRouteName').value.trim();
            const distance = parseFloat(document.getElementById('newRouteDistance').value) || null;
            const fromCityId = document.getElementById('fromCitySelect').value;
            const toCityId = document.getElementById('toCitySelect').value;
            if (!name) { alert('Please enter route name'); return; }

            try {
                const { error } = await supabaseClient.from('routes').insert({
                    name: name,
                    from_city_id: parseInt(fromCityId),
                    to_city_id: parseInt(toCityId),
                    distance: distance
                });
                if (error) throw error;
                hideAddRouteForm();
                await loadRoutes();
                showSuccess('Route added successfully!');
            } catch (error) {
                alert('Error adding route: ' + error.message);
            }
        }

        async function deleteRoute(routeId) {
            if (!confirm('Delete this route and all its stops?')) return;
            try {
                const { error } = await supabaseClient.from('routes').delete().eq('id', routeId);
                if (error) throw error;
                await loadRoutes();
                hideStopsSection();
                showSuccess('Route deleted successfully!');
            } catch (error) {
                alert('Error deleting route: ' + error.message);
            }
        }

        async function selectRoute(routeId, routeName, fromCity, toCity) {
            selectedRoute = { id: routeId, name: routeName, fromCity: fromCity, toCity: toCity };
            document.getElementById('selectedRouteName').textContent = routeName;
            document.getElementById('selectedRouteDetails').textContent = `${fromCity} ‚Üí ${toCity}`;
            document.getElementById('stopsSection').classList.remove('hidden');
            await loadStops();
        }

        function hideStopsSection() {
            document.getElementById('stopsSection').classList.add('hidden');
            selectedRoute = null;
        }

        async function loadStops() {
            if (!selectedRoute) return;
            try {
                const { data, error } = await supabaseClient
                    .from('route_stops')
                    .select('*, stops(*)')
                    .eq('route_id', selectedRoute.id)
                    .order('rank');
                if (error) throw error;
                updateStopsTable(data || []);
            } catch (error) {
                console.error('Error loading stops:', error);
                document.getElementById('stopsTable').innerHTML = '<tr><td colspan="3" style="color: var(--danger);">Error loading stops</td></tr>';
            }
        }

        function updateStopsTable(stops) {
            const tbody = document.getElementById('stopsTable');
            if (stops.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center">No stops found</td></tr>';
                return;
            }
            tbody.innerHTML = stops.map(routeStop => `
                <tr>
                    <td><div class="stop-order">${routeStop.rank}</div></td>
                    <td><strong>${routeStop.stops?.name || 'Unknown Stop'}</strong></td>
                    <td><button onclick="deleteStop('${routeStop.route_id}', '${routeStop.stop_id}')" class="btn btn-danger btn-sm">Delete</button></td>
                </tr>
            `).join('');
        }

        async function addStop() {
            if (!selectedRoute) return;
            const name = document.getElementById('newStopName').value.trim();
            const order = parseInt(document.getElementById('newStopOrder').value) || 1;
            if (!name) { alert('Please enter a stop name'); return; }
            try {
                const { data: stopData, error: stopError } = await supabaseClient.from('stops').insert({ name: name }).select().single();
                if (stopError) throw stopError;
                const { error: routeStopError } = await supabaseClient.from('route_stops').insert({
                    route_id: selectedRoute.id, stop_id: stopData.id, rank: order, is_pickup: true, is_drop: true
                });
                if (routeStopError) throw routeStopError;
                document.getElementById('newStopName').value = '';
                document.getElementById('newStopOrder').value = '';
                await loadStops();
                showSuccess('Stop added successfully!');
            } catch (error) {
                alert('Error adding stop: ' + error.message);
            }
        }

        async function deleteStop(routeId, stopId) {
            if (!confirm('Delete this stop from the route?')) return;
            try {
                const { error } = await supabaseClient.from('route_stops').delete().eq('route_id', routeId).eq('stop_id', stopId);
                if (error) throw error;
                await loadStops();
                showSuccess('Stop deleted successfully!');
            } catch (error) {
                alert('Error deleting stop: ' + error.message);
            }
        }

        async function loadUsers() {
            try {
                const { data, error } = await supabaseClient.from('profiles').select('*').order('created_at', { ascending: false }).limit(50);
                if (error) throw error;
                updateUsersTable(data || []);
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTable').innerHTML = '<tr><td colspan="4" style="color: var(--danger);">Error loading users</td></tr>';
            }
        }

        function updateUsersTable(users) {
            const tbody = document.getElementById('usersTable');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No users found</td></tr>';
                return;
            }
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.email || '-'}</td>
                    <td>${user.role || 'rider'}</td>
                    <td>${user.docs_verified ? '‚úÖ Yes' : '‚ùå No'}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                </tr>
            `).join('');
        }

        async function loadRides() {
            try {
                const { data, error } = await supabaseClient.from('rides').select('*, profiles!rides_driver_id_fkey(email)').order('created_at', { ascending: false }).limit(50);
                if (error) throw error;
                updateRidesTable(data || []);
            } catch (error) {
                console.error('Error loading rides:', error);
                document.getElementById('ridesTable').innerHTML = '<tr><td colspan="4" style="color: var(--danger);">Error loading rides</td></tr>';
            }
        }

        function updateRidesTable(rides) {
            const tbody = document.getElementById('ridesTable');
            if (rides.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No rides found</td></tr>';
                return;
            }
            tbody.innerHTML = rides.map(ride => `
                <tr>
                    <td>${ride.pickup_location} ‚Üí ${ride.drop_location}</td>
                    <td>${ride.profiles?.email || 'Unknown'}</td>
                    <td>${ride.depart_date || '-'}</td>
                    <td>${ride.status || 'active'}</td>
                </tr>
            `).join('');
        }

        async function loadFinancial() {
            try {
                const { data: wallets, error: walletsError } = await supabaseClient.from('wallets').select('balance_available_inr');
                if (walletsError) throw walletsError;
                const totalBalance = wallets?.reduce((sum, wallet) => sum + (wallet.balance_available_inr || 0), 0) || 0;
                document.getElementById('walletBalance').textContent = `‚Çπ${totalBalance.toFixed(2)}`;
            } catch (error) {
                console.error('Error loading financial data:', error);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('loginError').classList.add('hidden');
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            const container = document.querySelector('.container');
            container.insertBefore(successDiv, container.firstChild);
            setTimeout(() => {
                if (successDiv.parentNode) successDiv.parentNode.removeChild(successDiv);
            }, 3000);
        }

        // Global function declarations
        window.addCity = addCity;
        window.deleteCity = deleteCity;
        window.loadRoutes = loadRoutes;
        window.showAddRouteForm = showAddRouteForm;
        window.hideAddRouteForm = hideAddRouteForm;
        window.addRoute = addRoute;
        window.deleteRoute = deleteRoute;
        window.selectRoute = selectRoute;
        window.hideStopsSection = hideStopsSection;
        window.addStop = addStop;
        window.deleteStop = deleteStop;
    </script>
</body>
</html>